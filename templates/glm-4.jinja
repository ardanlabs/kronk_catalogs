{# GLM-4 template for gonja #}
{%- macro visible_text(content) -%}
{%- if content is string -%}
{{- content }}
{%- elif content is iterable and content is not mapping -%}
{%- for item in content -%}
{%- if item is mapping and item.type == 'text' -%}
{{- item.text }}
{%- elif item is string -%}
{{- item }}
{%- endif -%}
{%- endfor -%}
{%- else -%}
{{- content }}
{%- endif -%}
{%- endmacro -%}

[gMASK]<sop>
{%- if tools is defined and tools | length > 0 -%}
<|system|>
# Tools

You may call one or more functions to assist with the user query.

You are provided with function signatures within <tools></tools> XML tags:
<tools>
{%- for tool in tools %}
{%- if tool.function is defined %}
{%- set func = tool.function %}
{%- else %}
{%- set func = tool %}
{%- endif %}
{"type": "function", "function": {"name": "{{ func.name }}", "description": "{{ func.description }}", "parameters": {{ func.parameters | tojson }}}}
{%- endfor %}
</tools>

For each function call, output the function name and arguments within the following XML format:
<tool_call>
<name>function_name</name>
<arguments>{"arg_name": "arg_value"}</arguments>
</tool_call>
{%- endif -%}

{% for m in messages %}
{%- if m.role == 'user' -%}
<|user|>{{ visible_text(m.content) }}
{%- elif m.role == 'assistant' -%}
<|assistant|></think>
{%- if m.content is defined and m.content is string and m.content | length > 0 -%}
{{ m.content }}
{%- endif -%}
{%- if m.tool_calls is defined and m.tool_calls | length > 0 %}
{%- for tc in m.tool_calls %}
{%- if tc.function is defined %}
{%- set tcfunc = tc.function %}
{%- else %}
{%- set tcfunc = tc %}
{%- endif %}
<tool_call>
<name>{{ tcfunc.name }}</name>
<arguments>{{ tcfunc.arguments }}</arguments>
</tool_call>
{%- endfor %}
{%- endif %}
{%- elif m.role == 'tool' -%}
<|observation|><tool_response>{{ m.content }}</tool_response>
{%- elif m.role == 'system' -%}
<|system|>{{ visible_text(m.content) }}
{%- endif -%}
{%- endfor -%}
{%- if add_generation_prompt -%}
<|assistant|><think>
{%- endif -%}
